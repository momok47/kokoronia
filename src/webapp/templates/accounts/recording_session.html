{% extends 'base.html' %}

{% block title %}音声録音セッション - Kokoronia{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center">
                        <i class="fas fa-microphone"></i> 音声録音セッション
                    </h3>
                    <p class="text-center text-muted mb-0">
                        ようこそ {{ user.first_name }} {{ user.last_name }} さん
                    </p>
                </div>
                <div class="card-body">
                    <div id="recording-setup" class="recording-phase">
                        <h4 class="mb-3">
                            <i class="fas fa-cog"></i> 録音設定
                        </h4>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            会話相手のアカウントIDを入力してセッションを開始してください
                        </div>
                        
                        <form id="setup-form">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="participant2" class="form-label">
                                    会話相手のアカウントID
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="participant2" 
                                       name="participant2"
                                       placeholder="相手のアカウントIDを入力"
                                       required>
                                <div class="form-text">
                                    登録済みのユーザーのアカウントIDを入力してください
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="session-name" class="form-label">
                                    セッション名 (オプション)
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="session-name" 
                                       name="session_name"
                                       placeholder="例: 今日の雑談">
                            </div>
                            
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-play"></i> 録音セッション開始
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="recording-active" class="recording-phase" style="display: none;">
                        <h4 class="mb-3 text-center">
                            <i class="fas fa-record-vinyl text-danger"></i> 録音中...
                        </h4>
                        
                        <div class="text-center mb-4">
                            <div class="recording-indicator">
                                <div class="pulse-animation"></div>
                            </div>
                            <p class="mt-3">会話を開始してください</p>
                            <p class="text-muted">録音を停止するには下のボタンを押してください</p>
                            <p class="small">録音時間: <span id="recording-time">0:00</span></p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6>参加者1</h6>
                                        <strong>{{ user.account_id }}</strong>
                                        <br>{{ user.first_name }} {{ user.last_name }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6>参加者2</h6>
                                        <strong id="participant2-display"></strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid mt-4">
                            <button type="button" 
                                    class="btn btn-danger btn-lg" 
                                    id="stop-recording">
                                <i class="fas fa-stop"></i> 録音停止
                            </button>
                        </div>
                    </div>
                    
                    <div id="recording-processing" class="recording-phase text-center" style="display: none;">
                        <h4 class="mb-3">
                            <i class="fas fa-spinner fa-spin"></i> 処理中...
                        </h4>
                        <p>音声を分析しています。しばらくお待ちください。</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 100%"></div>
                        </div>
                        <p class="mt-2 small text-muted" id="processing-status">音声をアップロード中...</p>
                    </div>
                    
                    <div id="recording-complete" class="recording-phase" style="display: none;">
                        <h4 class="mb-3 text-success">
                            <i class="fas fa-check-circle"></i> 完了！
                        </h4>
                        <div class="alert alert-success">
                            <p class="mb-2">音声の分析が完了しました。</p>
                            <div id="analysis-results"></div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" 
                                    class="btn btn-primary" 
                                    id="new-session">
                                <i class="fas fa-plus"></i> 新しいセッション
                            </button>
                            <a href="{% url 'accounts:index' %}" class="btn btn-secondary">
                                <i class="fas fa-home"></i> ホームに戻る
                            </a>
                        </div>
                    </div>
                    
                    <div id="recording-error" class="recording-phase" style="display: none;">
                        <h4 class="mb-3 text-danger">
                            <i class="fas fa-exclamation-triangle"></i> エラーが発生しました
                        </h4>
                        <div class="alert alert-danger">
                            <p id="error-message">不明なエラーが発生しました。</p>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" 
                                    class="btn btn-primary" 
                                    id="retry-session">
                                <i class="fas fa-redo"></i> 再試行
                            </button>
                            <a href="{% url 'accounts:index' %}" class="btn btn-secondary">
                                <i class="fas fa-home"></i> ホームに戻る
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.recording-indicator {
    position: relative;
    width: 60px;
    height: 60px;
    margin: 0 auto;
    background-color: #dc3545;
    border-radius: 50%;
}

.pulse-animation {
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    border: 3px solid #dc3545;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.7;
    }
    100% {
        transform: scale(1.2);
        opacity: 0;
    }
}

.recording-phase {
    transition: all 0.3s ease;
}
</style>

<script>
class AudioRecordingSession {
    constructor() {
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.isRecording = false;
        this.recordingStartTime = null;
        this.recordingTimer = null;
        
        this.initializeElements();
        this.bindEvents();
        this.checkBrowserSupport();
    }
    
    initializeElements() {
        this.setupForm = document.getElementById('setup-form');
        this.setupPhase = document.getElementById('recording-setup');
        this.activePhase = document.getElementById('recording-active');
        this.processingPhase = document.getElementById('recording-processing');
        this.completePhase = document.getElementById('recording-complete');
        this.errorPhase = document.getElementById('recording-error');
        
        this.stopRecordingBtn = document.getElementById('stop-recording');
        this.newSessionBtn = document.getElementById('new-session');
        this.retrySessionBtn = document.getElementById('retry-session');
        
        this.participant2Input = document.getElementById('participant2');
        this.sessionNameInput = document.getElementById('session-name');
        this.participant2Display = document.getElementById('participant2-display');
        this.recordingTimeDisplay = document.getElementById('recording-time');
        this.processingStatusDisplay = document.getElementById('processing-status');
        this.analysisResultsDisplay = document.getElementById('analysis-results');
        this.errorMessageDisplay = document.getElementById('error-message');
    }
    
    bindEvents() {
        this.setupForm.addEventListener('submit', (e) => this.handleSetupSubmit(e));
        this.stopRecordingBtn.addEventListener('click', () => this.stopRecording());
        this.newSessionBtn.addEventListener('click', () => this.resetSession());
        this.retrySessionBtn.addEventListener('click', () => this.resetSession());
    }
    
    checkBrowserSupport() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            this.showError('お使いのブラウザは音声録音をサポートしていません。');
            return false;
        }
        if (!window.MediaRecorder) {
            this.showError('お使いのブラウザはMediaRecorderをサポートしていません。');
            return false;
        }
        return true;
    }
    
    async handleSetupSubmit(e) {
        e.preventDefault();
        
        const participant2 = this.participant2Input.value.trim();
        if (!participant2) {
            alert('会話相手のアカウントIDを入力してください');
            return;
        }
        
        // 参加者2の表示を更新
        this.participant2Display.textContent = participant2;
        
        try {
            // マイクアクセス許可を取得
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
            
            this.startRecording(stream);
        } catch (error) {
            console.error('マイクアクセス取得エラー:', error);
            this.showError('マイクへのアクセス許可が必要です。ブラウザの設定を確認してください。');
        }
    }
    
    startRecording(stream) {
        try {
            // MediaRecorderの設定
            const options = {
                mimeType: 'audio/webm;codecs=opus'
            };
            
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'audio/webm';
            }
            
            this.mediaRecorder = new MediaRecorder(stream, options);
            this.audioChunks = [];
            
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    this.audioChunks.push(event.data);
                }
            };
            
            this.mediaRecorder.onstop = () => {
                stream.getTracks().forEach(track => track.stop());
                this.processRecording();
            };
            
            this.mediaRecorder.onerror = (event) => {
                console.error('MediaRecorder エラー:', event.error);
                this.showError('録音中にエラーが発生しました: ' + event.error);
            };
            
            // 録音開始
            this.mediaRecorder.start(1000); // 1秒ごとにデータを取得
            this.isRecording = true;
            this.recordingStartTime = Date.now();
            
            // UI切り替え
            this.setupPhase.style.display = 'none';
            this.activePhase.style.display = 'block';
            
            // タイマー開始
            this.startRecordingTimer();
            
            console.log('録音を開始しました');
        } catch (error) {
            console.error('録音開始エラー:', error);
            this.showError('録音の開始に失敗しました: ' + error.message);
        }
    }
    
    stopRecording() {
        if (!this.isRecording || !this.mediaRecorder) return;
        
        this.isRecording = false;
        this.clearRecordingTimer();
        
        // 録音停止
        this.mediaRecorder.stop();
        
        console.log('録音を停止しました');
    }
    
    startRecordingTimer() {
        this.recordingTimer = setInterval(() => {
            if (!this.recordingStartTime) return;
            
            const elapsed = Math.floor((Date.now() - this.recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            this.recordingTimeDisplay.textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }
    
    clearRecordingTimer() {
        if (this.recordingTimer) {
            clearInterval(this.recordingTimer);
            this.recordingTimer = null;
        }
    }
    
    async processRecording() {
        // 処理中フェーズに切り替え
        this.activePhase.style.display = 'none';
        this.processingPhase.style.display = 'block';
        
        try {
            // 音声データをBlobに変換
            const audioBlob = new Blob(this.audioChunks, { 
                type: this.mediaRecorder.mimeType 
            });
            
            console.log('録音データサイズ:', audioBlob.size, 'バイト');
            
            // サーバーにアップロード
            await this.uploadAndProcessAudio(audioBlob);
            
        } catch (error) {
            console.error('録音処理エラー:', error);
            this.showError('録音データの処理中にエラーが発生しました: ' + error.message);
        }
    }
    
    async uploadAndProcessAudio(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        formData.append('participant1', '{{ user.account_id }}');
        formData.append('participant2', this.participant2Input.value.trim());
        formData.append('session_name', this.sessionNameInput.value.trim());
        formData.append('csrfmiddlewaretoken', 
                        document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        try {
            this.processingStatusDisplay.textContent = '音声をアップロード中...';
            
            const response = await fetch('{% url "accounts:process_recording" %}', {
                method: 'POST',
                body: formData,
            });
            
            if (!response.ok) {
                throw new Error(`サーバーエラー: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'success') {
                this.showComplete(result);
            } else {
                throw new Error(result.message || '処理に失敗しました');
            }
            
        } catch (error) {
            console.error('アップロードエラー:', error);
            this.showError('サーバーへのアップロードに失敗しました: ' + error.message);
        }
    }
    
    showComplete(result) {
        this.processingPhase.style.display = 'none';
        this.completePhase.style.display = 'block';
        
        // 分析結果の表示
        let resultsHTML = '<p><strong>分析結果:</strong></p>';
        if (result.analysis) {
            resultsHTML += `<p>検出されたトピック: <strong>${result.analysis.best_topic}</strong></p>`;
            resultsHTML += `<p>信頼度: <strong>${(result.analysis.best_score * 100).toFixed(1)}%</strong></p>`;
        } else {
            resultsHTML += '<p>結果はあなたのプロフィールに反映されます。</p>';
        }
        
        this.analysisResultsDisplay.innerHTML = resultsHTML;
    }
    
    showError(message) {
        // 全てのフェーズを非表示
        this.setupPhase.style.display = 'none';
        this.activePhase.style.display = 'none';
        this.processingPhase.style.display = 'none';
        this.completePhase.style.display = 'none';
        
        // エラーフェーズを表示
        this.errorMessageDisplay.textContent = message;
        this.errorPhase.style.display = 'block';
        
        // 録音を停止
        this.cleanup();
    }
    
    resetSession() {
        this.cleanup();
        
        // UI リセット
        this.errorPhase.style.display = 'none';
        this.completePhase.style.display = 'none';
        this.processingPhase.style.display = 'none';
        this.activePhase.style.display = 'none';
        this.setupPhase.style.display = 'block';
        
        // フォームクリア
        this.setupForm.reset();
        this.recordingTimeDisplay.textContent = '0:00';
        this.analysisResultsDisplay.innerHTML = '';
    }
    
    cleanup() {
        // 録音の完全停止
        this.isRecording = false;
        this.clearRecordingTimer();
        
        if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
            this.mediaRecorder.stop();
        }
        
        // 初期化
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.recordingStartTime = null;
    }
}

// ページ読み込み完了後に初期化
document.addEventListener('DOMContentLoaded', function() {
    new AudioRecordingSession();
});
</script>
{% endblock %} 