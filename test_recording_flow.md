# 🧪 録音→分析→保存フロー テスト手順書

## 📋 事前準備チェックリスト

### **1. 環境設定確認**
```bash
# 1. プロジェクトディレクトリに移動
cd /Users/shirakawamomoko/Desktop/lounge

# 2. 仮想環境アクティベート
source .venv/bin/activate  # または conda activate lounge

# 3. 必要な環境変数が設定されているか確認
echo $GOOGLE_APPLICATION_CREDENTIALS
# → GCSサービスアカウントキーのパスが表示されるべき

# 4. Djangoサーバー起動
cd src/webapp
python manage.py runserver
```

### **2. デバイス確認**
- **最低2つの音声入力デバイス**が利用可能である
- **マイク権限**がブラウザで許可されている
- **テスト用ユーザー**が作成済み（test_user1, test_user2など）

### **3. データベース確認**
```bash
# ユーザーが存在するか確認
python manage.py shell
>>> from accounts.models import User
>>> User.objects.filter(account_id__in=['test_user1', 'test_user2']).count()
# → 2 と表示されればOK
>>> exit()
```

## 🚀 テスト実行手順

### **Phase 1: Web画面での録音セットアップ**

1. **ブラウザでアクセス**: `http://127.0.0.1:8000/`
2. **ログイン**: test_user1でログイン
3. **録音画面移動**: 「会話をスタート！」→ `/recording/`
4. **デバイス一覧確認**:
   - ✅ デバイス一覧が正常表示される
   - ✅ 2つ以上のデバイスが検出される
   - ✅ デバイス名とIDが正しく表示される

### **Phase 2: 録音セッション開始**

5. **入力フォーム**:
   ```
   デバイス1: [利用可能なID] (例: 0)
   ユーザー1: test_user1
   デバイス2: [別のID] (例: 2)  
   ユーザー2: test_user2
   ```

6. **「会話を開始！」クリック**:
   - ✅ 録音中画面に切り替わる
   - ✅ デバイス情報が正しく表示される
   - ✅ 録音時間カウンターが動作する
   - ✅ 赤いパルスアニメーションが表示される

### **Phase 3: 録音実行**

7. **実際に会話する** (30秒〜1分程度):
   - 複数のトピック（例：「今日はテクノロジーについて話そう」「ビジネスの話もしたい」）
   - 明確な音声でテスト

8. **「録音停止・分析開始」クリック**:
   - ✅ 録音中画面が消える
   - ✅ 処理中画面に切り替わる
   - ✅ プログレスバーが10%から開始

### **Phase 4: 処理中の進行状況確認**

9. **進行状況監視** (2-5分間):
   ```
   期待される表示:
   🔄 音声データ処理中... (15%)
   ☁️ GCSアップロード中... (35%)
   📝 文字起こし中... (65%) 
   🧠 関心度分析中... (85%)
   💾 データベース保存中... (95%)
   ✅ 処理完了 (100%)
   ```

10. **ターミナル監視**:
    ```bash
    # Djangoサーバーのターミナルで以下が出力されるか確認:
    === テスト: セッション開始 ===
    Session ID: [ID]
    === テスト: ファイルパス確認 ===
    Main.py Exists: True
    === テスト: 実行環境 ===
    GOOGLE_APPLICATION_CREDENTIALS: 設定済み
    ✅ 進行状況更新: 10% - 処理開始
    === テスト: プロセス実行開始 ===
    === テスト: プロセス実行完了 ===
    実行時間: [時間]秒
    リターンコード: 0
    === テスト: 分析結果抽出 ===
    分析結果: {...}
    ✅ 処理成功: 進行状況を100%に更新
    ```

### **Phase 5: 結果画面確認**

11. **結果画面表示**:
    - ✅ 実行成功ステータス（緑）
    - ✅ 分析結果セクション表示
    - ✅ 検出されたトピックがバッジで表示
    - ✅ 参加者情報が正しい
    - ✅ 標準出力に詳細ログ

12. **データベース確認**:
    ```bash
    # 分析結果が保存されているか確認
    python manage.py shell
    >>> from accounts.models import UserTopicScore
    >>> UserTopicScore.objects.filter(user__account_id__in=['test_user1', 'test_user2']).count()
    # → 0より大きい値が表示されればOK
    ```

## ⚠️ 想定される問題とトラブルシューティング

### **1. デバイス検出エラー**
```
エラー: マイクが見つかりません
対処: 
- macOSの場合: システム環境設定 → セキュリティとプライバシー → プライバシー → マイク
- PyAudio再インストール: pip install --upgrade pyaudio
```

### **2. GCS認証エラー**
```
エラー: 環境変数 GOOGLE_APPLICATION_CREDENTIALS が設定されていません
対処:
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/service-account-key.json"
```

### **3. ユーザー存在エラー**
```
エラー: アカウントID 'test_user1' のユーザーが見つかりません
対処:
python manage.py shell
>>> from accounts.models import User
>>> User.objects.create_user(account_id='test_user1', email='test1@example.com', password='testpass123', first_name='太郎', last_name='田中')
```

### **4. タイムアウトエラー**
```
エラー: 実行がタイムアウトしました (15分)
対処:
- ネットワーク接続確認
- GCS APIクォータ確認  
- 音声ファイルサイズ確認
```

### **5. 分析結果が表示されない**
```
問題: 結果画面で分析結果セクションが空
対処:
- 標準出力にトピック情報があるか確認
- 音声が明確でトピックを含んでいるか確認
```

## 📊 成功基準

### **✅ 成功条件**
1. **録音操作**: スムーズな録音セッション制御
2. **進行状況**: リアルタイムな進行状況表示
3. **処理完了**: タイムアウトなしでの完了
4. **分析結果**: 構造化されたトピック検出結果
5. **データ保存**: データベースへの正常な保存

### **📈 パフォーマンス基準**  
- **処理時間**: 5分以内での完了
- **進行表示**: 2秒以内での更新反映
- **UI応答**: 1秒以内のボタン反応

## 🔄 テスト反復

**推奨テスト回数**: 3-5回
**異なる条件**:
- 短い録音（10秒）vs 長い録音（3分）
- 単一トピック vs 複数トピック
- 異なるデバイス組み合わせ
- 異なるユーザー組み合わせ

---

**🎯 このテストを実行して、各段階の結果を教えてください！** 